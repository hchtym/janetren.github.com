
-- v3.查询入账流水情况
select 
a.accdate,a.acctime,a.termid,a.termseqno,a.transdate,a.transtime,a.cardbefbal,a.cardaftbal,a.amount,a.managefee,
a.custname,a.cardno,a.cardcnt,b.transname||a.transcode,
a.sysid,a.devphyid,a.status,a.errcode,a.remark,a.refno,a.stuempno,a.transflag,a.custid
from v_transdtl a left join t_transcode b on a.transcode=b.transcode
where a.cardno=? and cardcnt<>0 order by a.transdate,a.transtime;

-- v3.统计卡库不平情况sql
	select '总不平账户数' type,count(*) "账户数",sum(balance-cardbal) "总金额"  from t_account t where 		
	cardbal<>balance  and status='1'
	union all
	select  '库比卡大账户数' type,count(*) "账户数",nvl(sum(balance-cardbal),0) "总金额"   from t_account t where 
	balance>cardbal  and status='1'
	union all
	select  '库比卡小账户数' type,count(*) "账户数",nvl(sum(balance-cardbal),0) "总金额"   from t_account t where 
  balance<cardbal  and status='1'
  union all
  select '平衡账户数' type,count(*)  "账户数",0  "总金额"  from t_account t where 	cardbal=balance and status='1'

-- v3.统计写卡失败情况
select transdate,count(*) from v_recenttransdtl 
where accdate>='20100707' and transcode=3290 group by transdate;

-- v3.统计实时流水数量
select transdate,count(*) from v_recenttransdtl
where accdate>='20100707' and offlineflag=1  group by transdate;

-- v3.统计脱机流水数量
select transdate,count(*) from v_recenttransdtl
where accdate>='20100707' and offlineflag=2  group by transdate;

-- v3.统计补采流水情况
select transdate,count(*) from v_recenttransdtl
where accdate>='20100707' and offlineflag=3  group by transdate;

-- v3.统计缺失流水数量
select transdate, transtime, termid, devicename, startno, endno
  from (select sum(devseqno) over(PARTITION BY a.termid order by a.termid, a.devseqno rows between 1 preceding and 0 following) - devseqno + 1 as startno,
               devseqno - 1 as endno,
               transdate,
               transtime,
               a.termid,
               b.devicename
          from (select termid, transdate, transtime, devphyid, devseqno
                  from YKT_CUR.t_posdtl
                 where devseqno > 0) a,
               t_device b
         where a.termid = b.deviceid
           and a.transdate >= '20100707'
           and devseqno <= 999999) t
 where endno - startno + 1 > 0
   and endno - startno + 1 < 100
   and startno > 1;


-- 查看数据锁的情况
select /*+ RULE */ 
 ls.osuser os_user_name, 
 ls.username user_name, 
 decode(ls.type, 
        'RW', 
        'Row wait enqueue lock', 
        'TM', 
        'DML enqueue lock', 
                'TX', 
        'Transaction enqueue lock', 
        'UL', 
        'User supplied lock') lock_type, 
 o.object_name object, 
 decode(ls.lmode, 
        1, 
        null, 
        2, 
        'Row Share', 
        3, 
        'Row Exclusive', 
        4, 
        'Share', 
        5, 
        'Share Row Exclusive', 
                6, 
        'Exclusive', 
        null) lock_mode, 
 o.owner, 
 ls.sid, 
 ls.serial# serial_num, 
 ls.id1, 
 ls.id2 
  from sys.dba_objects o, 
       (select s.osuser, 
               s.username, 
               l.type, 
               l.lmode, 
               s.sid, 
               s.serial#, 
               l.id1, 
               l.id2 
          from v$session s, v$lock l 
         where s.sid = l.sid) ls 
 where o.object_id = ls.id1 
   and o.owner <> 'SYS' 
 order by o.owner, o.object_name; 
 

-- 查看正在执行的SQL

select sid, 
       v$session.username 用户名, 
       last_call_et 持续时间, 
       status 状态, 
       LOCKWAIT 等待锁, 
       machine 用户电脑名, 
       logon_time 开始登入时间, 
       sql_fulltext 
  from v$session, v$process, v$sqlarea 
 where paddr = addr 
   and sql_hash_value = hash_value 
   and status = 'ACTIVE' 
   and v$session.username is not null 
 order by last_call_et desc;

--查看表空间使用情况
select f.tablespace_name, 
       a.total || 'M', 
       u.used || 'M', 
       f.free || 'M', 
       round((u.used / a.total) * 100) "% used", 
       round((f.free / a.total) * 100) "% Free" 
  from (select tablespace_name, sum(bytes / (1024 * 1024)) total 
          from dba_data_files 
         group by tablespace_name) a, 
       (select tablespace_name, round(sum(bytes / (1024 * 1024))) used 
          from dba_extents 
         group by tablespace_name) u, 
       (select tablespace_name, round(sum(bytes / (1024 * 1024))) free 
          from dba_free_space 
         group by tablespace_name) f 
 WHERE a.tablespace_name = f.tablespace_name 
   and a.tablespace_name = u.tablespace_name; 

-- 查看表空间所使用的磁盘文件是否超过 25G。
select b.file_name phyFilename, 
       b.tablespace_name tablespaceName, 
       b.bytes / 1024 / 1024 / 1024 sizeG, 
       (b.bytes - sum(nvl(a.bytes, 0))) / 1024 / 1024 / 1024 usedG, 
       substr((b.bytes - sum(nvl(a.bytes, 0))) / (b.bytes) * 100, 1, 5) "%Used"
  from dba_free_space a, dba_data_files b 
 where a.file_id = b.file_id 
 group by b.tablespace_name, b.file_name, b.bytes 
 order by b.tablespace_name; 

